# 实时检测故障排查指南

## 当前问题：推理结果失败

根据你的日志：
```
推理结果: 失败
未检测到目标
```

这说明 YOLO 模型没有检测到盲道。

## 排查步骤

### 步骤 1：确认模型在图片模式下能正常工作

1. 切换到"图片检测"标签
2. 选择一张包含盲道的图片
3. 将置信度阈值调到 0.25
4. 点击"执行分割"
5. 查看是否能检测到

**如果图片模式能检测到**：
- 说明模型正常
- 问题在实时检测的图像转换

**如果图片模式也检测不到**：
- 说明模型或图片有问题
- 检查 `best.onnx` 是否正确
- 检查图片是否包含盲道

### 步骤 2：检查实时相机画面

**问题可能**：
1. 相机没有对准盲道
2. 光线太暗或太亮
3. 距离太远或太近
4. 盲道被遮挡

**解决方法**：
- 确保相机清晰对准盲道
- 在光线充足的环境测试
- 保持合适的距离（1-2米）
- 避免遮挡物

### 步骤 3：降低置信度阈值

我已经将实时检测的置信度从 0.5 降到 0.25。

**位置**：`CameraManager.kt` 第 125 行
```kotlin
val result = yoloModel.runInference(bitmap, confThreshold = 0.25f)
```

重新运行应用，看是否能检测到。

### 步骤 4：检查图像转换

**可能问题**：
- YUV → Bitmap 转换错误
- 图像旋转不正确
- 图像尺寸不对

**验证方法**：
查看日志中的 "Bitmap 尺寸"，应该是合理的值（如 1280x720）

### 步骤 5：使用测试图片验证可视化

1. 切换到"图片检测"模式
2. 选择一张能检测到盲道的图片
3. 执行分割
4. 查看调试信息中的：
   - 前景像素数
   - 重心坐标
   - PCA 角度

如果这些都正常，说明可视化系统没问题，只是实时检测没有检测到目标。

## 常见原因和解决方案

### 原因 1：相机画面不包含盲道

**症状**：
- 推理结果：失败
- 前景像素数：0

**解决**：
- 将手机对准盲道
- 确保盲道在画面中央
- 保持稳定

### 原因 2：置信度阈值太高

**症状**：
- 图片模式能检测到
- 实时模式检测不到

**解决**：
- 已降低到 0.25
- 如果还不行，可以继续降低到 0.1

**修改位置**：
```kotlin
// CameraManager.kt 第 125 行
val result = yoloModel.runInference(bitmap, confThreshold = 0.1f)
```

### 原因 3：光线条件不好

**症状**：
- 白天能检测到
- 晚上检测不到

**解决**：
- 在光线充足的环境测试
- 开启手机闪光灯
- 避免逆光

### 原因 4：图像转换问题

**症状**：
- Bitmap 尺寸异常
- 图像旋转错误

**解决**：
- 检查日志中的 "Bitmap 尺寸"
- 如果尺寸为 0x0，说明转换失败
- 如果尺寸正常但检测不到，可能是旋转问题

### 原因 5：模型文件问题

**症状**：
- 图片模式也检测不到
- 任何图片都失败

**解决**：
- 检查 `app/src/main/assets/best.onnx` 是否存在
- 确认模型是 YOLOv8-Seg 格式
- 确认模型训练的是盲道类别

## 调试技巧

### 1. 查看完整日志

在 Android Studio 的 Logcat 中搜索：
- `实时检测调试`
- `DebugOverlay`
- `推理结果`

### 2. 对比图片模式和实时模式

**图片模式**：
- 能检测到 → 模型正常
- 检测不到 → 模型或图片问题

**实时模式**：
- 能检测到 → 一切正常
- 检测不到 → 相机或转换问题

### 3. 使用已知的测试图片

准备一张确定包含盲道的图片：
1. 在图片模式下测试
2. 调整置信度直到能检测到
3. 记录这个置信度值
4. 在实时模式下使用相同的置信度

### 4. 检查性能统计

查看"性能统计"卡片：
- 总帧数：应该持续增加
- 处理帧数：应该定期增加
- 推理耗时：应该在 100-200ms

如果处理帧数一直是 0，说明推理没有执行。

## 下一步操作

### 立即尝试：

1. **重新运行应用**（已降低置信度到 0.25）
2. **将相机对准明显的盲道**
3. **确保光线充足**
4. **查看新的日志输出**

### 如果还是失败：

1. **切换到图片模式**
2. **选择测试图片**
3. **将置信度降到 0.1**
4. **查看是否能检测到**
5. **把结果告诉我**

### 发送给我的信息：

1. **图片模式能否检测到**（是/否）
2. **使用的置信度阈值**（0.1/0.25/0.5）
3. **前景像素数**（从调试信息中）
4. **新的 Logcat 日志**（特别是"实时检测调试"部分）

## 临时解决方案

如果实时检测一直失败，可以：

1. **使用图片模式进行演示**
   - 准备几张盲道图片
   - 在图片模式下展示检测效果
   - 可视化系统同样有效

2. **录制演示视频**
   - 在能检测到的环境录制
   - 展示完整的检测过程
   - 用于答辩和演示

3. **调整模型参数**
   - 降低置信度阈值
   - 调整 NMS 阈值
   - 重新训练模型

## 预期的正常日志

当检测成功时，应该看到：
```
=== 实时检测调试 ===
Bitmap 尺寸: 1280x720
推理结果: 成功
置信度: 0.59
maskArray 长度: 409600
前景像素数: 13614 / 409600
Overlay View: 存在
可视化数据: 成功
重心: (320.5, 400.2)
偏移状态: 0
转向状态: 1
PCA 角度: 18.5
Overlay 已更新
==================

DebugOverlay: mask 已更新, 长度=409600
DebugOverlay: centroid 已更新, 值=(320.5, 400.2)
DebugOverlay: pcaAngle 已更新, 值=18.5

=== DebugOverlay onDraw ===
View 尺寸: 984x912
mask: 存在
centroid: (320.5, 400.2)
pcaAngle: 18.5
开始绘制 mask
开始绘制 centroid
开始绘制 PCA 方向
onDraw 完成
======================
```

对比你当前的日志，主要差异是：
- ❌ 推理结果: 失败（应该是"成功"）
- ❌ mask: null（应该有数据）
- ❌ centroid: null（应该有坐标）

这确认了问题在于 YOLO 推理没有检测到目标。
